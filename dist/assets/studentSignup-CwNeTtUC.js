import{s as x}from"./config-4EZbmldV.js";import{createClient as S}from"https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/+esm";const _=x.url,A=x.anonKey,c=S(_,A);let n={age:"",parentEmail:"",firstName:"",email:"",password:""};const L=document.getElementById("panel1"),I=document.getElementById("panel2"),M=document.getElementById("panel1Form"),R=document.getElementById("panel2Form"),D=document.getElementById("backBtn"),d=document.getElementById("errorMessage"),m=document.getElementById("successMessage"),B=document.getElementById("panelTitle"),b=document.getElementById("panelSubtitle"),l=document.getElementById("step1Indicator"),C=document.getElementById("step2Indicator"),P=document.getElementById("progressLine");function e(a){d.textContent=a,d.classList.add("show"),m.classList.remove("show"),window.scrollTo({top:0,behavior:"smooth"})}function U(a){m.textContent=a,m.classList.add("show"),d.classList.remove("show"),window.scrollTo({top:0,behavior:"smooth"})}function h(){d.classList.remove("show"),m.classList.remove("show")}function T(a){a===1?(L.classList.add("active"),I.classList.remove("active"),B.textContent="Let's Get Started!",b.textContent="Tell us a bit about yourself",l.classList.add("active"),l.classList.remove("completed"),C.classList.remove("active"),P.classList.remove("completed")):a===2&&(L.classList.remove("active"),I.classList.add("active"),B.textContent="Create Your Account",b.textContent="Choose your username and password",l.classList.remove("active"),l.classList.add("completed"),C.classList.add("active"),P.classList.add("completed")),h()}async function F(a){try{const{data:r,error:t}=await c.rpc("check_email_availability",{check_email:a});return t?(console.error("Error checking email availability:",t),!1):r===!0}catch(r){return console.error("Error checking email:",r),!1}}M.addEventListener("submit",async a=>{a.preventDefault(),h();const r=document.getElementById("studentAge").value,t=document.getElementById("parentEmail").value.trim();if(!r){e("Please select your age");return}if(!t){e("Please enter your parent's email");return}if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(t)){e("Please enter a valid email address");return}n.age=parseInt(r),n.parentEmail=t,T(2)});D.addEventListener("click",()=>{T(1)});R.addEventListener("submit",async a=>{a.preventDefault(),h();const r=document.getElementById("firstName").value.trim(),t=document.getElementById("email").value.trim(),i=document.getElementById("password").value,k=document.getElementById("captcha").value;if(!r){e("Please enter your first name");return}if(!t){e("Please enter your email address");return}if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(t)){e("Please enter a valid email address");return}if(!i||i.length<6){e("Password must be at least 6 characters long");return}if(k!=="8"){e("Incorrect answer. Please try again. What is 5 + 3?"),document.getElementById("captcha").value="";return}const u=document.getElementById("signupBtn"),g=document.getElementById("signupBtnText");u.disabled=!0,g.innerHTML='<span class="loading-spinner"></span>Creating Account...';try{if(!await F(t)){e("This email is already registered. Please use a different email or try logging in."),u.disabled=!1,g.textContent="Sign Up";return}let s=null;const{data:v,error:f}=await c.from("user_profiles").select("id, account_type").eq("email",n.parentEmail).eq("account_type","parent").maybeSingle();f&&f.code!=="PGRST116"&&console.error("Error looking up parent:",f),v&&(s=v.id);const{data:E,error:o}=await c.auth.signUp({email:t,password:i,options:{data:{account_type:"student",first_name:r}}});if(o)throw o.message&&o.message.toLowerCase().includes("already registered")?new Error("This email is already registered. Please use a different email or try logging in."):o;if(E.user){const w={id:E.user.id,email:t,account_type:"student",first_name:r,age:n.age,parent_email:n.parentEmail};s&&(w.parent_id=s);const{error:y}=await c.from("user_profiles").insert(w);if(y)throw console.error("Error creating profile:",y),y;localStorage.setItem("newStudentSignup","true"),localStorage.setItem("studentEmail",t),U("Account created successfully! Redirecting to avatar selection..."),setTimeout(()=>{window.location.href="avatar-selection.html"},1500)}}catch(p){console.error("Signup error:",p);const s=p.message||"";s.toLowerCase().includes("already registered")||s.toLowerCase().includes("already exists")||s.includes("duplicate key")?e("This email is already registered. Please use a different email or try logging in at auth.html"):s.includes("violates check constraint")?e("Unable to create student account. Please check your information and try again."):s.toLowerCase().includes("email")&&s.toLowerCase().includes("invalid")?e("Please enter a valid email address."):e(s||"An error occurred during signup. Please try again.")}finally{u.disabled=!1,g.textContent="Sign Up"}});
