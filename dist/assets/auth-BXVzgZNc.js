import{s as v}from"./config-4EZbmldV.js";import{createClient as M}from"https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/+esm";const k=v.url,U=v.anonKey,r=M(k,U);let l=!1,d="";const S=new URLSearchParams(window.location.search),_=S.get("mode"),F=S.get("type");_==="signup"&&(l=!0,d=F||localStorage.getItem("accountType")||"");const w=document.getElementById("authTitle"),p=document.getElementById("authSubtitle"),u=document.getElementById("submitBtnText"),E=document.getElementById("googleBtnText"),I=document.getElementById("toggleText"),h=document.getElementById("toggleModeLink"),B=document.getElementById("forgotPasswordContainer"),A=document.getElementById("authForm"),D=document.getElementById("googleSignInBtn"),m=document.getElementById("errorMessage"),g=document.getElementById("successMessage"),G=document.getElementById("modeToggleTop"),x=document.getElementById("modeToggleTopText"),T=document.getElementById("modeToggleIcon");function y(){l?(w.textContent="Create a free account",p.textContent=`Join SciQuest Heroes as a ${d||"member"}`,u.textContent="Sign Up",E.textContent="Sign up with Google",I.textContent="Already have an account?",h.textContent="Log In",x.textContent="Log In",T.className="fas fa-sign-in-alt",B.style.display="none"):(w.textContent="Welcome Back!",p.textContent="Sign in to continue your adventure",u.textContent="Log In",E.textContent="Continue with Google",I.textContent="Don't have an account?",h.textContent="Sign Up",x.textContent="Sign Up",T.className="fas fa-user-plus",B.style.display="block")}y();function C(e){e.preventDefault(),l=!l,y(),f()}h.addEventListener("click",C);G.addEventListener("click",C);function i(e){m.textContent=e,m.classList.add("show"),g.classList.remove("show")}function b(e){g.textContent=e,g.classList.add("show"),m.classList.remove("show")}function f(){m.classList.remove("show"),g.classList.remove("show")}function L(e){const o=document.getElementById("submitBtn"),n=document.getElementById("googleSignInBtn");e?(o.disabled=!0,n.disabled=!0,u.innerHTML='<span class="loading-spinner"></span>Processing...'):(o.disabled=!1,n.disabled=!1,u.textContent=l?"Sign Up":"Log In")}async function P(e,o,n){try{const{data:t}=await r.from("user_profiles").select("*").eq("id",e).maybeSingle();if(t){console.log("User profile already exists");return}const{error:s}=await r.from("user_profiles").insert({id:e,email:o,account_type:n||"student"});if(s){if(s.code==="23505"){console.log("User profile already exists (duplicate key)");return}throw console.error("Error creating user profile:",s),s}}catch(t){throw console.error("Failed to create user profile:",t),t}}A.addEventListener("submit",async e=>{e.preventDefault(),f();const o=document.getElementById("email").value.trim(),n=document.getElementById("password").value;if(!o||!n){i("Please fill in all fields");return}if(n.length<6){i("Password must be at least 6 characters long");return}L(!0);try{if(l){const{data:t,error:s}=await r.auth.signUp({email:o,password:n});if(s)throw s;if(t.user){await P(t.user.id,o,d),b("Account created successfully! Redirecting...");const a=d||"student";localStorage.removeItem("accountType"),setTimeout(()=>{a==="parent"?window.location.href="parent-dashboard.html":a==="teacher"?window.location.href="teacher-dashboard.html":a==="student"?window.location.href="student-dashboard.html":window.location.href="index.html"},1500)}}else{const{data:t,error:s}=await r.auth.signInWithPassword({email:o,password:n});if(s)throw s;if(t.user){b("Login successful! Redirecting...");const{data:a}=await r.from("user_profiles").select("account_type").eq("id",t.user.id).maybeSingle();setTimeout(()=>{a&&a.account_type==="parent"?window.location.href="parent-dashboard.html":a&&a.account_type==="teacher"?window.location.href="teacher-dashboard.html":a&&a.account_type==="student"?window.location.href="student-dashboard.html":window.location.href="index.html"},1500)}}}catch(t){console.error("Auth error:",t),t.message.includes("Invalid login credentials")?i("Invalid email or password. Please try again."):t.message.includes("User already registered")?(i("This email is already registered. Please log in instead."),setTimeout(()=>{l=!1,y(),f()},2e3)):t.message.includes("Email not confirmed")?i("Please check your email to confirm your account."):t.message.includes("duplicate key")?i("This account already exists. Please log in instead."):i(t.message||"An error occurred. Please try again.")}finally{L(!1)}});D.addEventListener("click",async()=>{f();try{const{data:e,error:o}=await r.auth.signInWithOAuth({provider:"google",options:{redirectTo:window.location.origin+"/index.html",queryParams:{prompt:"select_account"}}});if(o)throw o}catch(e){console.error("Google sign-in error:",e),i("Failed to sign in with Google. Please try again.")}});document.getElementById("forgotPasswordLink").addEventListener("click",e=>{e.preventDefault(),q()});function q(){const e=document.getElementById("forgotPasswordModal");e.style.display="flex",document.getElementById("resetEmail").value=document.getElementById("email").value}window.closeForgotPasswordModal=function(){const e=document.getElementById("forgotPasswordModal");e.style.display="none",document.getElementById("resetErrorMessage").classList.remove("show"),document.getElementById("resetSuccessMessage").classList.remove("show")};document.getElementById("resetPasswordForm").addEventListener("submit",async e=>{e.preventDefault();const o=document.getElementById("resetEmail").value.trim(),n=document.getElementById("resetErrorMessage"),t=document.getElementById("resetSuccessMessage"),s=document.getElementById("resetSubmitBtn"),a=document.getElementById("resetBtnText");if(!o){n.textContent="Please enter your email address",n.classList.add("show");return}s.disabled=!0,a.innerHTML='<span class="loading-spinner"></span>Sending...';try{const{error:c}=await r.auth.resetPasswordForEmail(o,{redirectTo:window.location.origin+"/auth.html"});if(c)throw c;t.textContent="Password reset email sent! Check your inbox.",t.classList.add("show"),n.classList.remove("show"),setTimeout(()=>{closeForgotPasswordModal()},3e3)}catch(c){console.error("Password reset error:",c),n.textContent=c.message||"Failed to send reset email. Please try again.",n.classList.add("show"),t.classList.remove("show")}finally{s.disabled=!1,a.textContent="Send Reset Link"}});r.auth.onAuthStateChange((e,o)=>{(async()=>{if(e==="SIGNED_IN"&&o){const{data:n}=await r.from("user_profiles").select("*").eq("id",o.user.id).maybeSingle();if(!n){const t=d||localStorage.getItem("accountType")||"student";try{await P(o.user.id,o.user.email,t)}catch(s){console.error("Error creating profile during auth state change:",s)}}}})()});
