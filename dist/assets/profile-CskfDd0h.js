import{s as v}from"./config-4EZbmldV.js";import{createClient as x}from"https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/+esm";const C=v.url,L=v.anonKey,l=x(C,L),w=document.getElementById("userMenuTrigger"),f=document.getElementById("dropdownMenu"),N=document.getElementById("logoutBtn"),m=document.getElementById("userAvatarSmall"),T=document.getElementById("userNameNav"),g=document.getElementById("profileAvatar"),S=document.getElementById("profileTitle"),r=document.getElementById("accountTypeBadge"),y=document.getElementById("profileForm"),u=document.getElementById("errorMessage"),d=document.getElementById("successMessage"),h=document.getElementById("saveBtnText"),M=document.getElementById("studentFieldsRow"),E=document.getElementById("firstName"),A=document.getElementById("username"),B=document.getElementById("age"),I=document.getElementById("parentEmail"),P=document.getElementById("email"),_=document.getElementById("fullName");let p=null;function i(t){u.textContent=t,u.classList.add("show"),d.classList.remove("show"),window.scrollTo({top:0,behavior:"smooth"})}function F(t){d.textContent=t,d.classList.add("show"),u.classList.remove("show"),window.scrollTo({top:0,behavior:"smooth"})}function q(){u.classList.remove("show"),d.classList.remove("show")}async function k(){const{data:{session:t}}=await l.auth.getSession();if(!t){window.location.href="auth.html";return}const{data:e}=await l.from("user_profiles").select("account_type").eq("id",t.user.id).maybeSingle();if(e&&e.account_type!=="student"){window.location.href="index.html";return}b(t.user.id)}async function b(t){try{const{data:e,error:c}=await l.from("user_profiles").select("*").eq("id",t).maybeSingle();if(c)throw c;if(e){p=e;const s=e.first_name||e.full_name||e.username||e.email;if(T.textContent=s,S.textContent=`${s}'s Profile`,E.value=e.first_name||"",A.value=e.username||"",P.value=e.email||"",_.value=e.full_name||"",e.account_type==="student"?(M.style.display="grid",B.value=e.age||"",I.value=e.parent_email||"",r.className="badge badge-student",r.textContent="Student"):e.account_type==="parent"?(r.className="badge badge-parent",r.textContent="Parent"):e.account_type==="teacher"&&(r.className="badge badge-teacher",r.textContent="Teacher"),e.avatar_url)m.innerHTML=`<img src="${e.avatar_url}" alt="Avatar">`,g.innerHTML=`<img src="${e.avatar_url}" alt="Avatar">`;else if(e.first_name){const a=e.first_name.charAt(0).toUpperCase();m.textContent=a,g.textContent=a}else if(e.username){const a=e.username.charAt(0).toUpperCase();m.textContent=a,g.textContent=a}}}catch(e){console.error("Error loading profile:",e),i("Failed to load profile data")}}w.addEventListener("click",t=>{t.stopPropagation(),f.classList.toggle("show")});document.addEventListener("click",t=>{!w.contains(t.target)&&!f.contains(t.target)&&f.classList.remove("show")});N.addEventListener("click",async()=>{try{const{error:t}=await l.auth.signOut();if(t)throw t;localStorage.clear(),sessionStorage.clear(),window.location.href="auth.html"}catch(t){console.error("Logout error:",t),alert("Failed to logout. Please try again.")}});y.addEventListener("submit",async t=>{t.preventDefault(),q();const e=E.value.trim(),c=_.value.trim();if(!e&&p.account_type==="student"){i("First name is required");return}const s={first_name:e||null,full_name:c||null};if(p.account_type==="student"){const n=parseInt(B.value),o=I.value.trim();if(n&&(n<5||n>12)){i("Age must be between 5 and 12");return}if(o&&!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(o)){i("Please enter a valid parent email address");return}s.age=n||null,s.parent_email=o||null}const a=y.querySelector('button[type="submit"]');a.disabled=!0,h.innerHTML='<span class="loading-spinner"></span>Saving...';try{const{data:{session:n}}=await l.auth.getSession();if(!n)throw new Error("No active session");const{error:o}=await l.from("user_profiles").update(s).eq("id",n.user.id);if(o)throw o;F("Profile updated successfully!"),await b(n.user.id)}catch(n){console.error("Error updating profile:",n),i("Failed to update profile. Please try again.")}finally{a.disabled=!1,h.textContent="Save Changes"}});k();
